<!-- fc595c19-bd5f-4de4-b65b-ff6be27495e3 879d2897-c287-437a-8160-d73460dc59d3 -->
# Integrate n8n query expansion into Compass search

### 1. Decide triggering UX and data flow

- **ux-flow**: Keep existing `SearchBar` behavior (navigating to `/results?q=...`) and have `ResultsPage` be responsible for calling the n8n webhook when a `q` is present.
- **expansion-scope**: Use the n8n-expanded queries only inside the results pipeline (no DB writes), and (for now) implement option **b)** – automatically fan out into existing search and aggregate – while leaving room to expose expanded queries in the UI later.

### 2. Add a small client-side API wrapper for the n8n webhook

- **new-helper**: Create a lightweight helper (e.g. `lib/api/query-expansion.ts`) that:
- Accepts a single query string.
- Calls the configured n8n webhook URL with the expected input JSON array: `[{ query: "..." }]`.
- Parses the response into a typed structure like `{ queries: { query, role, priority, hits }[] }`.
- Handles network/errors gracefully and falls back to just the original query if the call fails or responds unexpectedly.
- **config**: Read the n8n webhook URL from an environment variable (e.g. `NEXT_PUBLIC_N8N_WEBHOOK_URL`) so environments can differ without code changes.

### 3. Extend the results page to use expanded queries

- **results-call-site**: Update `ResultsPage` (in `app/results/page.tsx`) to:
- On mount or when `searchParams.q` changes, call the query-expansion helper.
- Maintain local state for: loading/error, the expanded query list, and the final set of queries to use for searching.
- **search-strategy**: Define how to map expanded queries into the existing `getCampsWithAuthors` call:
- For MVP, concatenate all expanded queries into a single synthetic search string (e.g. original query plus top N expanded queries, ordered by `priority` and maybe filtered by `role` like `core` + `context`).
- Pass this combined string into the existing `getCampsWithAuthors` logic via the existing `PositioningSnapshot` / `CampAccordion` query props by lifting a derived `searchQueryForDb` value.

### 4. Wire expanded query usage into existing components

- **positioning-snapshot**: Adjust the code path that ultimately calls `getPositioningMetrics` / `getCampsWithAuthors` so that it uses `searchQueryForDb` (the enriched query string) instead of just `searchParams.q`, without breaking existing simple queries.
- **camp-accordion**: Ensure the list of camps and authors it shows is driven by the enriched search (through its `query` prop), so users benefit from broader matches with no extra UI work.
- **transparency-hook (optional later)**: Add optional props/slots so the results page can show which expanded queries were used (e.g., a small “We also searched for…” component) without changing the core search logic yet.

### 5. Handle loading, errors, and fallbacks in the UI

- **loading-state**: Show a clear “Expanding your query…” or reuse existing loading language while the n8n call is in flight, then move into the normal “Loading positioning snapshot / camps” messages once DB requests start.
- **error-fallback**: If the n8n call fails or returns an empty `queries` list, skip expansion and just run the existing search using the original `q`, with an optional subtle inline message that expansion is temporarily unavailable.

### 6. Basic configuration and testing

- **env-setup**: Document the required env variable (`NEXT_PUBLIC_N8N_WEBHOOK_URL`) in `README.md` or a setup doc, including a short note about expected JSON in/out formats.
- **tests/manual-checks**: Manually test flows with:
- A typical query (`"AI will replace jobs"`) to confirm expanded coverage and that results appear in `/results`.
- Edge cases: very short queries, long queries near the 500-char limit, and network failure (by pointing to an invalid webhook) to confirm graceful degradation.
- **future-extension**: Note follow-ups: display expanded queries to the user for transparency (option a), and possibly log expansion metadata for analytics.

### To-dos

- [ ] Clarify the exact UX around when and where expanded queries and loading states appear on the results page.
- [ ] Create a typed helper around the n8n webhook (URL from env, POST input/parse output, graceful error handling).
- [ ] Update the results page logic to call the expansion helper when `q` is present and derive an enriched query string for DB search.
- [ ] Wire PositioningSnapshot and CampAccordion (and any other query consumers) to use the enriched query string without breaking existing behavior.
- [ ] Add loading and error/fallback UI states for the expansion request and search execution.
- [ ] Document env config and manually test typical and edge-case queries with and without a working n8n webhook.